stages:
  - build

volume:
  stage: build
  image: docker
  services:
    - docker:dind
  script:
    - 'apk add --no-cache
          bash
          curl
          git
          git-lfs
          openssh
          unzip
      '
    - ./build-opt "$CI_COMMIT_TAG"
    - '
      docker build
          --label ade_image_commit_sha="$CI_COMMIT_SHA"
          --label ade_image_commit_tag="$CI_COMMIT_TAG"
          -t image .
      '
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker tag image $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
    - docker tag image $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - tags
